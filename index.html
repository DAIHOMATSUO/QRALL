<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“± QRãƒªãƒ¼ãƒ€ãƒ¼ AllF</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #1a4789;
      --secondary-color: #10356f;
      --accent-color: #0d2a5a;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-bg: rgba(255,255,255,0.1);
      --border-color: rgba(255,255,255,0.3);
      --text-color: white;
      --font-family: 'BIZ UDã‚´ã‚·ãƒƒã‚¯', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      --border-radius: 8px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --font-size-sm: 0.8em;
      --font-size-md: 0.9em;
      --font-size-lg: 1.1em;
      --font-size-xl: 1.5em;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-family);
      background: var(--primary-color);
      color: var(--text-color);
      margin: 0;
      padding: var(--spacing-md);
      min-height: 100vh;
      line-height: 1.4;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin: var(--spacing-md) 0 var(--spacing-xl) 0;
      font-size: var(--font-size-xl);
    }
    
    .section {
      background: var(--light-bg);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      margin: var(--spacing-xl) 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .section h3 {
      margin: 0 0 var(--spacing-md) 0;
      font-size: var(--font-size-lg);
    }
    
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: var(--spacing-md) 0;
      gap: var(--spacing-md);
    }
    
    .setting-item label {
      font-size: var(--font-size-md);
      flex: 1;
    }
    
    .setting-item select, .setting-item input {
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: var(--spacing-xs);
      background: white;
      color: #333;
      font-size: var(--font-size-md);
      min-width: 120px;
    }
    
    #reader {
      width: 100%;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background: #000;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #reader video, #reader canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 60vh;
      object-fit: cover;
    }
    
    .status {
      text-align: center;
      font-size: var(--font-size-md);
      color: #ccc;
      margin: var(--spacing-md) 0;
      min-height: 24px;
    }
    
    .result {
      text-align: center;
      font-size: var(--font-size-lg);
      margin: var(--spacing-lg) 0;
      padding: var(--spacing-lg);
      background: var(--light-bg);
      border-radius: var(--border-radius);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      word-break: break-word;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      justify-content: center;
      margin: var(--spacing-xl) 0;
    }
    
    .btn {
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-md);
      background: var(--secondary-color);
      border: none;
      color: var(--text-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
      font-family: inherit;
    }
    
    .btn:hover:not(:disabled) {
      background: var(--accent-color);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-success { background: var(--success-color); }
    .btn-warning { background: var(--warning-color); color: #000; }
    .btn-danger { background: var(--danger-color); }
    
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-height: 400px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--light-bg);
    }
    
    th, td {
      border: 1px solid var(--border-color);
      padding: var(--spacing-md) var(--spacing-sm);
      text-align: center;
      font-size: var(--font-size-md);
    }
    
    th {
      background: var(--secondary-color);
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      word-break: break-word;
    }
    
    .data-cell {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .btn-table {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-sm);
      margin: 0 2px;
      min-width: auto;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      background: var(--primary-color);
      margin: 10% auto;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: var(--spacing-lg);
      top: var(--spacing-md);
    }
    
    .close:hover {
      color: white;
    }
    
    .form-group {
      margin: var(--spacing-lg) 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: bold;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: none;
      border-radius: var(--spacing-xs);
      font-size: var(--font-size-md);
      font-family: inherit;
    }
    
    .form-group textarea {
      height: 80px;
      resize: vertical;
    }
    
    .alert {
      padding: var(--spacing-md);
      border-radius: var(--spacing-xs);
      margin: var(--spacing-md) 0;
      text-align: center;
    }
    
    .alert-success { background: var(--success-color); }
    .alert-warning { background: var(--warning-color); color: #000; }
    .alert-danger { background: var(--danger-color); }
    
    .duplicate-warning {
      background: var(--warning-color);
      color: #000;
      padding: var(--spacing-sm);
      border-radius: var(--spacing-xs);
      margin: var(--spacing-sm) 0;
      font-size: var(--font-size-sm);
    }
    
    @media (max-width: 480px) {
      body { padding: var(--spacing-sm); }
      h1 { font-size: 1.3em; margin: var(--spacing-sm) 0 var(--spacing-lg) 0; }
      .btn { padding: var(--spacing-md); min-width: 70px; }
      th, td { padding: var(--spacing-sm) var(--spacing-xs); font-size: var(--font-size-sm); }
      .section { padding: var(--spacing-md); }
      .setting-item { flex-direction: column; align-items: flex-start; gap: var(--spacing-sm); }
      .setting-item select, .setting-item input { min-width: 100%; }
      .modal-content { margin: 20% auto; padding: var(--spacing-lg); }
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    .backup-section {
      border: 2px dashed var(--border-color);
      padding: var(--spacing-lg);
      text-align: center;
    }
    
    .backup-section input[type="file"] {
      margin: var(--spacing-md) 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± QRãƒªãƒ¼ãƒ€ãƒ¼ AllF</h1>
    
    <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ - éè¡¨ç¤º -->
    <div class="section" style="display: none;">
      <h3>âš™ï¸ ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š</h3>
      <div class="setting-item">
        <label for="extraction-mode">å“ç•ªæŠ½å‡º:</label>
        <select id="extraction-mode" aria-label="å“ç•ªæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰">
          <option value="off" selected>ç„¡åŠ¹</option>
          <option value="auto">è‡ªå‹• (5æ¡-5æ¡-5æ¡)</option>
          <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
          <option value="manual">æ‰‹å‹•ç¢ºèª</option>
        </select>
      </div>
      <div class="setting-item" id="custom-pattern-group" style="display:none;">
        <label for="custom-pattern">ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³:</label>
        <input type="text" id="custom-pattern" placeholder="ä¾‹: \d{4}-\d{4}-\d{4}" aria-label="ã‚«ã‚¹ã‚¿ãƒ æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³">
      </div>
      <div class="setting-item">
        <label for="quality-select">ã‚¹ã‚­ãƒ£ãƒ³ç²¾åº¦:</label>
        <select id="quality-select" aria-label="ã‚¹ã‚­ãƒ£ãƒ³å“è³ª">
          <option value="low">ä½ (é«˜é€Ÿ)</option>
          <option value="medium" selected>ä¸­ (æ¨™æº–)</option>
          <option value="high">é«˜ (ç²¾å¯†)</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="qrbox-select">ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢:</label>
        <select id="qrbox-select" aria-label="ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢ã‚µã‚¤ã‚º">
          <option value="200">å° (200px)</option>
          <option value="250" selected>ä¸­ (250px)</option>
          <option value="300">å¤§ (300px)</option>
          <option value="auto">è‡ªå‹•èª¿æ•´</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="duplicate-check">é‡è¤‡ãƒã‚§ãƒƒã‚¯:</label>
        <select id="duplicate-check" aria-label="é‡è¤‡æ¤œå‡ºè¨­å®š">
          <option value="off">ç„¡åŠ¹</option>
          <option value="exact" selected>å®Œå…¨ä¸€è‡´</option>
          <option value="time">æ™‚é–“åˆ¶é™ä»˜ã (30ç§’)</option>
        </select>
      </div>
    </div>

    <!-- ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
      <div id="reader" role="application" aria-label="QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼"></div>
      <div class="status" id="status" aria-live="polite">ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ä¸­...</div>
      <div class="result" id="result" aria-live="polite">ã‚¹ã‚­ãƒ£ãƒ³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="controls">
      <button id="start-btn" class="btn btn-success" aria-label="ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹">â–¶ï¸ é–‹å§‹</button>
      <button id="stop-btn" class="btn btn-danger" aria-label="ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢">â¹ï¸ åœæ­¢</button>
      <button id="switch-camera-btn" class="btn" aria-label="ã‚«ãƒ¡ãƒ©åˆ‡æ›¿">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
      <button id="save-btn" class="btn" aria-label="ãƒ‡ãƒ¼ã‚¿ä¿å­˜">ğŸ’¾ ä¿å­˜</button>
      <button id="export-btn" class="btn" aria-label="CSVå‡ºåŠ›">ğŸ“¥ CSVå‡ºåŠ›</button>
      <button id="clear-btn" class="btn btn-warning" aria-label="å±¥æ­´å‰Šé™¤">ğŸ—‘ï¸ å±¥æ­´å‰Šé™¤</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
      <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
      <div class="backup-section">
        <h4>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h4>
        <button id="backup-btn" class="btn">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
        <button id="restore-btn" class="btn">ğŸ“‚ å¾©å…ƒ</button>
        <input type="file" id="restore-file" accept=".json" style="display:none;" aria-label="å¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ">
        <div class="alert alert-warning" style="margin-top: var(--spacing-md);">
          å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™
        </div>
      </div>
    </div>
    
    <!-- å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="section">
      <h3>ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ (<span id="history-count">0</span>ä»¶)</h3>
      <div class="table-container">
        <table role="table" aria-label="ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«">
          <thead>
            <tr>
              <th scope="col">å“ç•ª/ãƒ‡ãƒ¼ã‚¿</th>
              <th scope="col">å…¥ã‚Šæ•°</th>
              <th scope="col">ç®±æ•°</th>
              <th scope="col">æ™‚åˆ»</th>
              <th scope="col">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="history-body" role="rowgroup">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="edit-modal" class="modal" role="dialog" aria-labelledby="edit-modal-title" aria-hidden="true">
    <div class="modal-content">
      <span class="close" aria-label="é–‰ã˜ã‚‹">&times;</span>
      <h3 id="edit-modal-title">ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h3>
      <form id="edit-form">
        <div class="form-group">
          <label for="edit-data">ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿:</label>
          <textarea id="edit-data" required aria-label="ç·¨é›†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-irisu">å…¥ã‚Šæ•°:</label>
          <input type="number" id="edit-irisu" min="1" step="1" required aria-label="å…¥ã‚Šæ•°">
        </div>
        <div class="form-group">
          <label for="edit-hakosu">ç®±æ•°:</label>
          <input type="number" id="edit-hakosu" min="1" step="1" required aria-label="ç®±æ•°">
        </div>
        <div class="controls">
          <button type="submit" class="btn btn-success">ğŸ’¾ ä¿å­˜</button>
          <button type="button" class="btn" id="cancel-edit">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // å®šæ•°å®šç¾©
    const CONFIG = {
      STORAGE_KEY: 'qrScanHistory_v2',
      SETTINGS_KEY: 'qrScanSettings_v2',
      DUPLICATE_TIME_LIMIT: 30000, // 30ç§’
      MAX_HISTORY_ITEMS: 1000,
      QUALITY_SETTINGS: {
        low: { fps: 15, aspectRatio: 1.0 },
        medium: { fps: 10, aspectRatio: 1.33 },
        high: { fps: 5, aspectRatio: 1.77 }
      },
      DEFAULT_PRODUCT_PATTERN: /\d{5}-\d{5}-\d{5}/,
      ERROR_MESSAGES: {
        CAMERA_PERMISSION: 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚',
        CAMERA_NOT_FOUND: 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
        CAMERA_IN_USE: 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚',
        SCAN_ERROR: 'ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚',
        UNKNOWN_ERROR: 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
      }
    };

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
    class QRReaderApp {
      constructor() {
        this.scanHistory = [];
        this.settings = {};
        this.qrReader = null;
        this.isScanning = false;
        this.currentFacingMode = "environment";
        this.lastScanTime = {};
        this.editingIndex = -1;
        
        console.log('QRãƒªãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
        
        this.initializeElements();
        this.loadData();
        this.attachEventListeners();
        this.updateUI();
        
        // ã‚«ãƒ¡ãƒ©æ¨©é™ã®äº‹å‰ãƒã‚§ãƒƒã‚¯
        this.checkCameraPermission();
        
        console.log('QRãƒªãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å®Œäº†');
      }

      async checkCameraPermission() {
        try {
          // æ¨©é™çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          if (navigator.permissions) {
            const permission = await navigator.permissions.query({ name: 'camera' });
            console.log('ã‚«ãƒ¡ãƒ©æ¨©é™çŠ¶æ…‹:', permission.state);
            
            if (permission.state === 'denied') {
              this.updateStatus('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'danger');
            } else if (permission.state === 'prompt') {
              this.updateStatus('ğŸ“± ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
            } else if (permission.state === 'granted') {
              this.updateStatus('ğŸ“± ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æº–å‚™å®Œäº†ã€‚ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹');
            }
          } else {
            this.updateStatus('ğŸ“± ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
          }
        } catch (error) {
          console.log('æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—:', error);
          this.updateStatus('ğŸ“± QRãƒªãƒ¼ãƒ€ãƒ¼ã®æº–å‚™å®Œäº†');
        }
      }

      initializeElements() {
        // DOMè¦ç´ ã®å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        this.elements = {
          reader: document.getElementById('reader'),
          status: document.getElementById('status'),
          result: document.getElementById('result'),
          historyBody: document.getElementById('history-body'),
          historyCount: document.getElementById('history-count'),
          
          // ãƒœã‚¿ãƒ³
          startBtn: document.getElementById('start-btn'),
          stopBtn: document.getElementById('stop-btn'),
          switchCameraBtn: document.getElementById('switch-camera-btn'),
          saveBtn: document.getElementById('save-btn'),
          exportBtn: document.getElementById('export-btn'),
          clearBtn: document.getElementById('clear-btn'),
          backupBtn: document.getElementById('backup-btn'),
          restoreBtn: document.getElementById('restore-btn'),
          restoreFile: document.getElementById('restore-file'),
          
          // è¨­å®š
          extractionMode: document.getElementById('extraction-mode'),
          customPattern: document.getElementById('custom-pattern'),
          customPatternGroup: document.getElementById('custom-pattern-group'),
          qualitySelect: document.getElementById('quality-select'),
          qrboxSelect: document.getElementById('qrbox-select'),
          duplicateCheck: document.getElementById('duplicate-check'),
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«
          editModal: document.getElementById('edit-modal'),
          editForm: document.getElementById('edit-form'),
          editData: document.getElementById('edit-data'),
          editIrisu: document.getElementById('edit-irisu'),
          editHakosu: document.getElementById('edit-hakosu'),
          cancelEdit: document.getElementById('cancel-edit'),
          closeModal: document.querySelector('.close')
        };
      }

      loadData() {
        try {
          // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
          const savedHistory = localStorage.getItem(CONFIG.STORAGE_KEY);
          this.scanHistory = savedHistory ? JSON.parse(savedHistory) : [];
          
          // è¨­å®šã®èª­ã¿è¾¼ã¿
          const savedSettings = localStorage.getItem(CONFIG.SETTINGS_KEY);
          this.settings = savedSettings ? JSON.parse(savedSettings) : {};
          
          // è¨­å®šã‚’UIã«åæ˜ 
          this.applySettings();
          
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          this.showAlert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
      }

      applySettings() {
        if (this.settings.extractionMode) {
          this.elements.extractionMode.value = this.settings.extractionMode;
        }
        if (this.settings.customPattern) {
          this.elements.customPattern.value = this.settings.customPattern;
        }
        if (this.settings.quality) {
          this.elements.qualitySelect.value = this.settings.quality;
        }
        if (this.settings.qrboxSize) {
          this.elements.qrboxSelect.value = this.settings.qrboxSize;
        }
        if (this.settings.duplicateCheck) {
          this.elements.duplicateCheck.value = this.settings.duplicateCheck;
        }
        
        this.toggleCustomPattern();
      }

      saveData() {
        try {
          // å±¥æ­´ã‚’åˆ¶é™æ•°ã§ãƒˆãƒªãƒ 
          if (this.scanHistory.length > CONFIG.MAX_HISTORY_ITEMS) {
            this.scanHistory = this.scanHistory.slice(-CONFIG.MAX_HISTORY_ITEMS);
          }
          
          localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(this.scanHistory));
          
          // è¨­å®šä¿å­˜
          this.settings = {
            extractionMode: this.elements.extractionMode.value,
            customPattern: this.elements.customPattern.value,
            quality: this.elements.qualitySelect.value,
            qrboxSize: this.elements.qrboxSelect.value,
            duplicateCheck: this.elements.duplicateCheck.value
          };
          localStorage.setItem(CONFIG.SETTINGS_KEY, JSON.stringify(this.settings));
          
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          this.showAlert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
      }

      attachEventListeners() {
        // ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        this.elements.startBtn.addEventListener('click', () => this.toggleScanner());
        this.elements.stopBtn.addEventListener('click', () => this.stopScanner());
        this.elements.switchCameraBtn.addEventListener('click', () => this.switchCamera());
        
        // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
        this.elements.saveBtn.addEventListener('click', () => this.saveData());
        this.elements.exportBtn.addEventListener('click', () => this.exportCSV());
        this.elements.clearBtn.addEventListener('click', () => this.clearHistory());
        this.elements.backupBtn.addEventListener('click', () => this.createBackup());
        this.elements.restoreBtn.addEventListener('click', () => this.elements.restoreFile.click());
        this.elements.restoreFile.addEventListener('change', (e) => this.restoreBackup(e));
        
        // è¨­å®šå¤‰æ›´
        this.elements.extractionMode.addEventListener('change', () => {
          this.toggleCustomPattern();
          this.restartScannerIfRunning();
        });
        this.elements.qualitySelect.addEventListener('change', () => this.restartScannerIfRunning());
        this.elements.qrboxSelect.addEventListener('change', () => this.restartScannerIfRunning());
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        this.elements.closeModal.addEventListener('click', () => this.closeEditModal());
        this.elements.cancelEdit.addEventListener('click', () => this.closeEditModal());
        this.elements.editForm.addEventListener('submit', (e) => this.saveEdit(e));
        
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => this.cleanup());
        window.addEventListener('visibilitychange', () => {
          if (document.hidden && this.isScanning) {
            console.log('ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã£ãŸãŸã‚ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢');
            this.stopScanner();
          }
        });
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼‰
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (this.isScanning) {
              console.log('ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´ã«ã‚ˆã‚Šã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’å†èµ·å‹•');
              this.restartScannerIfRunning();
            }
          }, 1000); // 1ç§’ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
        });
        
        // ç”»é¢å›è»¢å¯¾å¿œ
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (this.isScanning) {
              console.log('ç”»é¢å›è»¢ã«ã‚ˆã‚Šã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’å†èµ·å‹•');
              this.restartScannerIfRunning();
            }
          }, 1000); // å›è»¢å®Œäº†ã‚’å¾…ã¤
        });
      }

      toggleCustomPattern() {
        const isCustom = this.elements.extractionMode.value === 'custom';
        this.elements.customPatternGroup.style.display = isCustom ? 'flex' : 'none';
      }

      updateUI() {
        this.renderHistory();
        this.elements.historyCount.textContent = this.scanHistory.length;
        
        // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        this.elements.startBtn.textContent = this.isScanning ? 'â¸ï¸ ä¸€æ™‚åœæ­¢' : 'â–¶ï¸ é–‹å§‹';
        this.elements.stopBtn.disabled = !this.isScanning;
        this.elements.exportBtn.disabled = this.scanHistory.length === 0;
        this.elements.clearBtn.disabled = this.scanHistory.length === 0;
      }

      renderHistory() {
        this.elements.historyBody.innerHTML = '';
        
        if (this.scanHistory.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="5" style="text-align:center;color:#ccc;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>';
          this.elements.historyBody.appendChild(emptyRow);
          return;
        }
        
        this.scanHistory.forEach((item, index) => {
          const row = this.createHistoryRow(item, index);
          this.elements.historyBody.appendChild(row);
        });
      }

      createHistoryRow(item, index) {
        const row = document.createElement('tr');
        row.setAttribute('role', 'row');
        
        const time = new Date(item.timestamp || Date.now()).toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const displayData = this.escapeHtml(item.data);
        const truncatedData = displayData.length > 15 ? displayData.substring(0, 15) + '...' : displayData;
        const statusIcon = 'ğŸ“„'; // å“ç•ªæŠ½å‡ºæ©Ÿèƒ½ç„¡åŠ¹ãªã®ã§çµ±ä¸€ã‚¢ã‚¤ã‚³ãƒ³
        
        row.innerHTML = `
          <td class="data-cell" title="${displayData}">${statusIcon} ${truncatedData}</td>
          <td>${this.escapeHtml(item.irisu)}</td>
          <td>${this.escapeHtml(item.hakosu)}</td>
          <td>${time}</td>
          <td>
            <button class="btn btn-table" onclick="app.editItem(${index})" aria-label="ç·¨é›†">âœï¸</button>
            <button class="btn btn-table" onclick="app.viewDetails(${index})" aria-label="è©³ç´°">ğŸ‘ï¸</button>
            <button class="btn btn-table btn-danger" onclick="app.deleteItem(${index})" aria-label="å‰Šé™¤">ğŸ—‘ï¸</button>
          </td>
        `;
        
        return row;
      }

      // XSSå¯¾ç­–ã®HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      updateStatus(message, type = 'info') {
        this.elements.status.textContent = message;
        this.elements.status.className = `status ${type}`;
      }

      updateResult(message, isHtml = false) {
        if (isHtml) {
          this.elements.result.innerHTML = message;
        } else {
          this.elements.result.textContent = message;
        }
      }

      showAlert(message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        
        this.elements.result.innerHTML = '';
        this.elements.result.appendChild(alert);
        
        setTimeout(() => {
          if (this.elements.result.contains(alert)) {
            alert.remove();
          }
        }, 5000);
      }

      getQRBoxSize() {
        const selected = this.elements.qrboxSelect.value;
        if (selected === 'auto') {
          const width = Math.min(window.innerWidth - 40, 400);
          return Math.min(width * 0.7, 300);
        }
        return parseInt(selected);
      }

      getExtractionPattern() {
        const mode = this.elements.extractionMode.value;
        
        switch (mode) {
          case 'auto':
            return CONFIG.DEFAULT_PRODUCT_PATTERN;
          case 'custom':
            try {
              const pattern = this.elements.customPattern.value.trim();
              return pattern ? new RegExp(pattern) : null;
            } catch (error) {
              console.warn('ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç„¡åŠ¹:', error);
              return null;
            }
          case 'manual':
            return CONFIG.DEFAULT_PRODUCT_PATTERN;
          default:
            return null;
        }
      }

      extractProductCode(qrCodeMessage) {
        const mode = this.elements.extractionMode.value;
        
        if (mode === 'off') {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const pattern = this.getExtractionPattern();
        if (!pattern) {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const match = qrCodeMessage.match(pattern);
        if (!match) {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const extractedCode = match[0];
        
        if (mode === 'manual') {
          const confirmed = confirm(`å“ç•ªã‚’æ¤œå‡ºã—ã¾ã—ãŸ:\n${extractedCode}\n\nå…ƒãƒ‡ãƒ¼ã‚¿: ${qrCodeMessage}\n\nã“ã®å“ç•ªã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ`);
          if (!confirmed) {
            return { code: qrCodeMessage, isExtracted: false };
          }
        }
        
        return { code: extractedCode, isExtracted: true, originalData: qrCodeMessage };
      }

      checkDuplicate(data) {
        const duplicateMode = this.elements.duplicateCheck.value;
        
        if (duplicateMode === 'off') {
          return { isDuplicate: false };
        }
        
        const now = Date.now();
        
        if (duplicateMode === 'exact') {
          const exists = this.scanHistory.some(item => item.data === data);
          return { isDuplicate: exists, type: 'exact' };
        }
        
        if (duplicateMode === 'time') {
          const recent = this.lastScanTime[data];
          if (recent && (now - recent) < CONFIG.DUPLICATE_TIME_LIMIT) {
            return { isDuplicate: true, type: 'time', timeLeft: Math.ceil((CONFIG.DUPLICATE_TIME_LIMIT - (now - recent)) / 1000) };
          }
          this.lastScanTime[data] = now;
        }
        
        return { isDuplicate: false };
      }

      validateInput(irisu, hakosu) {
        const irisuNum = parseFloat(irisu);
        const hakosuNum = parseFloat(hakosu);
        
        if (isNaN(irisuNum) || irisuNum <= 0) {
          return { valid: false, message: 'å…¥ã‚Šæ•°ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
        }
        
        if (isNaN(hakosuNum) || hakosuNum <= 0) {
          return { valid: false, message: 'ç®±æ•°ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
        }
        
        if (!Number.isInteger(irisuNum) || !Number.isInteger(hakosuNum)) {
          return { valid: false, message: 'å…¥ã‚Šæ•°ã¨ç®±æ•°ã¯æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
        }
        
        return { valid: true };
      }

      async startScanner() {
        if (this.isScanning) {
          this.stopScanner();
          return;
        }
        
        try {
          this.updateStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...');
          
          // æ—¢å­˜ã®QRãƒªãƒ¼ãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (this.qrReader) {
            try {
              await this.qrReader.stop();
              this.qrReader.clear();
            } catch (e) {
              console.warn('æ—¢å­˜QRãƒªãƒ¼ãƒ€ãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:', e);
            }
          }
          
          this.qrReader = new Html5Qrcode("reader");
          
          const quality = CONFIG.QUALITY_SETTINGS[this.elements.qualitySelect.value];
          const qrboxSize = this.getQRBoxSize();
          
          const config = {
            fps: quality.fps,
            qrbox: qrboxSize,
            aspectRatio: quality.aspectRatio,
            disableFlip: false
          };

          // ã‚«ãƒ¡ãƒ©åˆ¶ç´„ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
          const cameraConstraints = { facingMode: this.currentFacingMode };
          
          console.log('ã‚«ãƒ¡ãƒ©èµ·å‹•é–‹å§‹:', { constraints: cameraConstraints, config });
          
          await this.qrReader.start(
            cameraConstraints,
            config,
            (qrCodeMessage) => this.handleScanSuccess(qrCodeMessage),
            (errorMessage) => {
              // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ã¯é€šå¸¸ç„¡è¦–
              console.debug('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆæ­£å¸¸ï¼‰:', errorMessage);
            }
          );
          
          this.isScanning = true;
          this.updateStatus('ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ä¸­... QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„', 'success');
          this.updateUI();
          
          console.log('ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
          
        } catch (error) {
          console.error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
          this.handleScanError(error);
        }
      }

      handleScanSuccess(qrCodeMessage) {
        try {
          // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
          if (navigator.vibrate) {
            navigator.vibrate(100);
          }
          
          // å“ç•ªæŠ½å‡ºã¯ç„¡åŠ¹ãªã®ã§ã€ãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
          const code = qrCodeMessage;
          const isExtracted = false;
          const originalData = qrCodeMessage;
          
          // é‡è¤‡ãƒã‚§ãƒƒã‚¯
          const duplicateCheck = this.checkDuplicate(code);
          
          let resultMessage = `âœ… èª­ã¿å–ã‚ŠæˆåŠŸ: ${this.escapeHtml(code)}`;
          
          if (duplicateCheck.isDuplicate) {
            resultMessage += `<br><div class="duplicate-warning">`;
            if (duplicateCheck.type === 'exact') {
              resultMessage += `âš ï¸ ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`;
            } else if (duplicateCheck.type === 'time') {
              resultMessage += `âš ï¸ ${duplicateCheck.timeLeft}ç§’å‰ã«ã‚¹ã‚­ãƒ£ãƒ³ã•ã‚Œã¦ã„ã¾ã™`;
            }
            resultMessage += `</div>`;
          }
          
          this.updateResult(resultMessage, true);
          
          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          let confirmMessage = `èª­ã¿å–ã‚Šçµæœ: ${code}\n\nç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;
          
          if (duplicateCheck.isDuplicate) {
            confirmMessage += '\n\nâ€» é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
          }
          
          if (confirm(confirmMessage)) {
            this.showDataInputDialog(code, originalData, isExtracted);
          }
          
        } catch (error) {
          console.error('ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          this.showAlert('ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
      }

      showDataInputDialog(code, originalData, isExtracted) {
        const irisu = prompt("å…¥ã‚Šæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "1");
        if (irisu === null) return;
        
        const hakosu = prompt("ç®±æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "1");
        if (hakosu === null) return;
        
        const validation = this.validateInput(irisu, hakosu);
        if (!validation.valid) {
          alert(validation.message);
          return;
        }
        
        this.addHistoryItem(code, originalData, isExtracted, irisu, hakosu);
      }

      addHistoryItem(data, originalData, isExtracted, irisu, hakosu) {
        const newItem = {
          data: data,
          originalData: originalData,
          isExtracted: isExtracted,
          irisu: irisu,
          hakosu: hakosu,
          timestamp: Date.now()
        };
        
        this.scanHistory.push(newItem);
        this.saveData();
        this.updateUI();
        
        const status = isExtracted ? ' - å“ç•ªæŠ½å‡ºæ¸ˆã¿' : '';
        this.updateStatus(`âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ (${this.scanHistory.length}ä»¶)${status}`, 'success');
      }

      handleScanError(error) {
        console.error('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        
        let message = CONFIG.ERROR_MESSAGES.UNKNOWN_ERROR;
        let suggestion = '';
        
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’è©³ç´°ã«åˆ¤å®š
        const errorStr = error.toString().toLowerCase();
        
        if (error.name === 'NotAllowedError' || errorStr.includes('permission') || errorStr.includes('denied')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_PERMISSION;
          suggestion = 'è§£æ±ºæ–¹æ³•:\n1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n2. ã€Œè¨±å¯ã€ã‚’é¸æŠ\n3. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
        } else if (error.name === 'NotFoundError' || errorStr.includes('no camera') || errorStr.includes('not found')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_NOT_FOUND;
          suggestion = 'è§£æ±ºæ–¹æ³•:\n1. ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n2. ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ãªã„ã‹ç¢ºèª\n3. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•';
        } else if (error.name === 'NotReadableError' || errorStr.includes('in use') || errorStr.includes('busy')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_IN_USE;
          suggestion = 'è§£æ±ºæ–¹æ³•:\n1. ä»–ã®ã‚¿ãƒ–ã‚„ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèª\n2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•\n3. ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ';
        } else if (errorStr.includes('https') || errorStr.includes('secure')) {
          message = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™';
          suggestion = 'è§£æ±ºæ–¹æ³•:\n1. https://ã§å§‹ã¾ã‚‹URLã§ã‚¢ã‚¯ã‚»ã‚¹\n2. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å ´åˆã¯localhostã‚’ä½¿ç”¨';
        }
        
        this.updateStatus(`âŒ ${message}`, 'danger');
        this.showAlert(message, 'danger');
        
        if (suggestion) {
          console.log(suggestion);
          // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
          setTimeout(() => {
            if (confirm(`${message}\n\nè©³ç´°ãªè§£æ±ºæ–¹æ³•ã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ`)) {
              alert(suggestion);
            }
          }, 1000);
        }
        
        this.isScanning = false;
        this.qrReader = null;
        this.updateUI();
      }

      stopScanner() {
        if (!this.isScanning && !this.qrReader) return;
        
        console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢é–‹å§‹');
        
        this.isScanning = false;
        
        if (this.qrReader) {
          this.qrReader.stop().then(() => {
            console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼æ­£å¸¸åœæ­¢');
            this.qrReader.clear();
            this.qrReader = null;
            this.updateStatus('â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            this.updateResult('ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            this.updateUI();
          }).catch(error => {
            console.warn('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
            this.qrReader.clear();
            this.qrReader = null;
            this.updateStatus('â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸï¼ˆå¼·åˆ¶ï¼‰');
            this.updateUI();
          });
        } else {
          this.updateStatus('â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
          this.updateUI();
        }
      }

      cleanup() {
        this.isScanning = false;
        if (this.qrReader) {
          try {
            this.qrReader.clear();
          } catch (error) {
            console.warn('QRãƒªãƒ¼ãƒ€ãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
          }
          this.qrReader = null;
        }
        this.updateUI();
      }

      toggleScanner() {
        if (this.isScanning) {
          this.stopScanner();
        } else {
          this.startScanner();
        }
      }

      switchCamera() {
        if (this.isScanning) {
          this.stopScanner();
          setTimeout(() => {
            this.currentFacingMode = this.currentFacingMode === "environment" ? "user" : "environment";
            this.updateStatus(`ğŸ“· ${this.currentFacingMode === "environment" ? "èƒŒé¢" : "å‰é¢"}ã‚«ãƒ¡ãƒ©ã«åˆ‡æ›¿ä¸­...`);
            this.startScanner();
          }, 500);
        } else {
          this.currentFacingMode = this.currentFacingMode === "environment" ? "user" : "environment";
          this.updateStatus(`ğŸ“· ${this.currentFacingMode === "environment" ? "èƒŒé¢" : "å‰é¢"}ã‚«ãƒ¡ãƒ©ã«è¨­å®šã—ã¾ã—ãŸ`);
        }
      }

      restartScannerIfRunning() {
        if (this.isScanning && this.qrReader) {
          console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å†èµ·å‹•é–‹å§‹');
          this.stopScanner();
          // ååˆ†ãªé–“éš”ã‚’ç©ºã‘ã¦å†èµ·å‹•
          setTimeout(() => {
            console.log('ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å†èµ·å‹•å®Ÿè¡Œ');
            this.startScanner();
          }, 1000);
        }
      }

      exportCSV() {
        if (this.scanHistory.length === 0) {
          this.showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
          return;
        }
        
        try {
          const now = new Date();
          const filename = `qr_history_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.csv`;
          
          const csvRows = ["ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿,å…¥ã‚Šæ•°,ç®±æ•°,ç™»éŒ²æ™‚åˆ»"];
          
          this.scanHistory.forEach(item => {
            const time = new Date(item.timestamp || Date.now()).toLocaleString('ja-JP');
            const data = item.data.replace(/"/g, '""');
            
            csvRows.push(`"${data}","${item.irisu}","${item.hakosu}","${time}"`);
          });
          
          const csvContent = "\uFEFF" + csvRows.join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          
          const link = document.createElement("a");
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showAlert(`ğŸ“¥ ${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
          }
        } catch (error) {
          console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
          this.showAlert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
      }

      clearHistory() {
        if (this.scanHistory.length === 0) {
          this.showAlert('å‰Šé™¤ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
          return;
        }
        
        if (confirm(`å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${this.scanHistory.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
          this.scanHistory = [];
          this.lastScanTime = {};
          this.saveData();
          this.updateUI();
          this.showAlert('ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }
      }

      createBackup() {
        try {
          const backupData = {
            version: '2.0',
            timestamp: Date.now(),
            history: this.scanHistory,
            settings: this.settings
          };
          
          const now = new Date();
          const filename = `qr_backup_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.json`;
          
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const link = document.createElement("a");
          
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showAlert(`ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ: ${filename}`, 'success');
          }
        } catch (error) {
          console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
          this.showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
      }

      restoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.version || !backupData.history) {
              throw new Error('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
            }
            
            if (confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿: ${this.scanHistory.length}ä»¶\nãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿: ${backupData.history.length}ä»¶\n\nâ€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™`)) {
              this.scanHistory = backupData.history || [];
              this.settings = backupData.settings || {};
              
              this.saveData();
              this.applySettings();
              this.updateUI();
              
              this.showAlert(`ğŸ“‚ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã—ãŸ (${this.scanHistory.length}ä»¶)`, 'success');
            }
          } catch (error) {
            console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
            this.showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'danger');
          }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      }

      editItem(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        this.editingIndex = index;
        const item = this.scanHistory[index];
        
        this.elements.editData.value = item.data;
        this.elements.editIrisu.value = item.irisu;
        this.elements.editHakosu.value = item.hakosu;
        
        this.elements.editModal.style.display = 'block';
        this.elements.editModal.setAttribute('aria-hidden', 'false');
        this.elements.editData.focus();
      }

      saveEdit(event) {
        event.preventDefault();
        
        if (this.editingIndex < 0 || this.editingIndex >= this.scanHistory.length) {
          this.closeEditModal();
          return;
        }
        
        const data = this.elements.editData.value.trim();
        const irisu = this.elements.editIrisu.value.trim();
        const hakosu = this.elements.editHakosu.value.trim();
        
        const validation = this.validateInput(irisu, hakosu);
        if (!validation.valid) {
          alert(validation.message);
          return;
        }
        
        if (!data) {
          alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        this.scanHistory[this.editingIndex].data = data;
        this.scanHistory[this.editingIndex].irisu = irisu;
        this.scanHistory[this.editingIndex].hakosu = hakosu;
        this.scanHistory[this.editingIndex].editedAt = Date.now();
        
        this.saveData();
        this.updateUI();
        this.closeEditModal();
        
        this.showAlert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      }

      closeEditModal() {
        this.elements.editModal.style.display = 'none';
        this.elements.editModal.setAttribute('aria-hidden', 'true');
        this.editingIndex = -1;
      }

      deleteItem(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        const item = this.scanHistory[index];
        if (confirm(`ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ‡ãƒ¼ã‚¿: ${item.data}\nå…¥ã‚Šæ•°: ${item.irisu}\nç®±æ•°: ${item.hakosu}`)) {
          this.scanHistory.splice(index, 1);
          this.saveData();
          this.updateUI();
          this.showAlert('ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        }
      }

      viewDetails(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        const item = this.scanHistory[index];
        const registeredTime = new Date(item.timestamp).toLocaleString('ja-JP');
        const editedTime = item.editedAt ? new Date(item.editedAt).toLocaleString('ja-JP') : 'ãªã—';
        
        const message = [
          'è©³ç´°æƒ…å ±:',
          '',
          `ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿: ${item.data}`,
          `å…¥ã‚Šæ•°: ${item.irisu}`,
          `ç®±æ•°: ${item.hakosu}`,
          `ç™»éŒ²æ™‚åˆ»: ${registeredTime}`,
          `ç·¨é›†æ™‚åˆ»: ${editedTime}`
        ].join('\n');
        
        alert(message);
      }
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    let app;
    
    document.addEventListener('DOMContentLoaded', () => {
      try {
        app = new QRReaderApp();
        console.log('QRãƒªãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
      } catch (error) {
        console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('status').textContent = 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', (event) => {
      if (event.target === document.getElementById('edit-modal')) {
        app?.closeEditModal();
      }
    });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        app?.closeEditModal();
      }
    });
  </script>
</body>
</html>