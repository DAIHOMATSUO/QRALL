<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì± QR„É™„Éº„ÉÄ„Éº AllF</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #1a4789;
      --secondary-color: #10356f;
      --accent-color: #0d2a5a;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-bg: rgba(255,255,255,0.1);
      --border-color: rgba(255,255,255,0.3);
      --text-color: white;
      --font-family: 'BIZ UD„Ç¥„Ç∑„ÉÉ„ÇØ', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      --border-radius: 8px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --font-size-sm: 0.8em;
      --font-size-md: 0.9em;
      --font-size-lg: 1.1em;
      --font-size-xl: 1.5em;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-family);
      background: var(--primary-color);
      color: var(--text-color);
      margin: 0;
      padding: var(--spacing-md);
      min-height: 100vh;
      line-height: 1.4;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin: var(--spacing-md) 0 var(--spacing-xl) 0;
      font-size: var(--font-size-xl);
    }
    
    .section {
      background: var(--light-bg);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      margin: var(--spacing-xl) 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .section h3 {
      margin: 0 0 var(--spacing-md) 0;
      font-size: var(--font-size-lg);
    }
    
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: var(--spacing-md) 0;
      gap: var(--spacing-md);
    }
    
    .setting-item label {
      font-size: var(--font-size-md);
      flex: 1;
    }
    
    .setting-item select, .setting-item input {
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: var(--spacing-xs);
      background: white;
      color: #333;
      font-size: var(--font-size-md);
      min-width: 120px;
    }
    
    #reader {
      width: 100%;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background: #000;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #reader video, #reader canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 60vh;
      object-fit: cover;
    }
    
    .status {
      text-align: center;
      font-size: var(--font-size-md);
      color: #ccc;
      margin: var(--spacing-md) 0;
      min-height: 24px;
    }
    
    .result {
      text-align: center;
      font-size: var(--font-size-lg);
      margin: var(--spacing-lg) 0;
      padding: var(--spacing-lg);
      background: var(--light-bg);
      border-radius: var(--border-radius);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      word-break: break-word;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      justify-content: center;
      margin: var(--spacing-xl) 0;
    }
    
    .btn {
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-md);
      background: var(--secondary-color);
      border: none;
      color: var(--text-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
      font-family: inherit;
    }
    
    .btn:hover:not(:disabled) {
      background: var(--accent-color);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-success { background: var(--success-color); }
    .btn-warning { background: var(--warning-color); color: #000; }
    .btn-danger { background: var(--danger-color); }
    
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-height: 400px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--light-bg);
    }
    
    th, td {
      border: 1px solid var(--border-color);
      padding: var(--spacing-md) var(--spacing-sm);
      text-align: center;
      font-size: var(--font-size-md);
    }
    
    th {
      background: var(--secondary-color);
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    td {
      word-break: break-word;
    }
    
    .data-cell {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .btn-table {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-sm);
      margin: 0 2px;
      min-width: auto;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
      background: var(--primary-color);
      margin: 10% auto;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: var(--spacing-lg);
      top: var(--spacing-md);
    }
    
    .close:hover {
      color: white;
    }
    
    .form-group {
      margin: var(--spacing-lg) 0;
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: bold;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: none;
      border-radius: var(--spacing-xs);
      font-size: var(--font-size-md);
      font-family: inherit;
    }
    
    .form-group textarea {
      height: 80px;
      resize: vertical;
    }
    
    .alert {
      padding: var(--spacing-md);
      border-radius: var(--spacing-xs);
      margin: var(--spacing-md) 0;
      text-align: center;
    }
    
    .alert-success { background: var(--success-color); }
    .alert-warning { background: var(--warning-color); color: #000; }
    .alert-danger { background: var(--danger-color); }
    
    .duplicate-warning {
      background: var(--warning-color);
      color: #000;
      padding: var(--spacing-sm);
      border-radius: var(--spacing-xs);
      margin: var(--spacing-sm) 0;
      font-size: var(--font-size-sm);
    }
    
    @media (max-width: 480px) {
      body { padding: var(--spacing-sm); }
      h1 { font-size: 1.3em; margin: var(--spacing-sm) 0 var(--spacing-lg) 0; }
      .btn { padding: var(--spacing-md); min-width: 70px; }
      th, td { padding: var(--spacing-sm) var(--spacing-xs); font-size: var(--font-size-sm); }
      .section { padding: var(--spacing-md); }
      .setting-item { flex-direction: column; align-items: flex-start; gap: var(--spacing-sm); }
      .setting-item select, .setting-item input { min-width: 100%; }
      .modal-content { margin: 20% auto; padding: var(--spacing-lg); }
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    .backup-section {
      border: 2px dashed var(--border-color);
      padding: var(--spacing-lg);
      text-align: center;
    }
    
    .backup-section input[type="file"] {
      margin: var(--spacing-md) 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì± QR„É™„Éº„ÉÄ„Éº AllF</h1>
    
    <!-- Ë®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ - ÈùûË°®Á§∫ -->
    <div class="section" style="display: none;">
      <h3>‚öôÔ∏è „Çπ„Ç≠„É£„É≥Ë®≠ÂÆö</h3>
      <div class="setting-item">
        <label for="extraction-mode">ÂìÅÁï™ÊäΩÂá∫:</label>
        <select id="extraction-mode" aria-label="ÂìÅÁï™ÊäΩÂá∫„É¢„Éº„Éâ">
          <option value="off" selected>ÁÑ°Âäπ</option>
          <option value="auto">Ëá™Âãï (5Ê°Å-5Ê°Å-5Ê°Å)</option>
          <option value="custom">„Ç´„Çπ„Çø„É†„Éë„Çø„Éº„É≥</option>
          <option value="manual">ÊâãÂãïÁ¢∫Ë™ç</option>
        </select>
      </div>
      <div class="setting-item" id="custom-pattern-group" style="display:none;">
        <label for="custom-pattern">„Ç´„Çπ„Çø„É†„Éë„Çø„Éº„É≥:</label>
        <input type="text" id="custom-pattern" placeholder="‰æã: \d{4}-\d{4}-\d{4}" aria-label="„Ç´„Çπ„Çø„É†Ê≠£Ë¶èË°®Áèæ„Éë„Çø„Éº„É≥">
      </div>
      <div class="setting-item">
        <label for="quality-select">„Çπ„Ç≠„É£„É≥Á≤æÂ∫¶:</label>
        <select id="quality-select" aria-label="„Çπ„Ç≠„É£„É≥ÂìÅË≥™">
          <option value="low">‰Ωé (È´òÈÄü)</option>
          <option value="medium" selected>‰∏≠ (Ê®ôÊ∫ñ)</option>
          <option value="high">È´ò (Á≤æÂØÜ)</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="qrbox-select">„Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢:</label>
        <select id="qrbox-select" aria-label="„Çπ„Ç≠„É£„É≥„Ç®„É™„Ç¢„Çµ„Ç§„Ç∫">
          <option value="200">Â∞è (200px)</option>
          <option value="250" selected>‰∏≠ (250px)</option>
          <option value="300">Â§ß (300px)</option>
          <option value="auto">Ëá™ÂãïË™øÊï¥</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="duplicate-check">ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ:</label>
        <select id="duplicate-check" aria-label="ÈáçË§áÊ§úÂá∫Ë®≠ÂÆö">
          <option value="off">ÁÑ°Âäπ</option>
          <option value="exact" selected>ÂÆåÂÖ®‰∏ÄËá¥</option>
          <option value="time">ÊôÇÈñìÂà∂Èôê‰ªò„Åç (30Áßí)</option>
        </select>
      </div>
    </div>

    <!-- „Ç´„É°„É©„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="section">
      <div id="reader" role="application" aria-label="QR„Ç≥„Éº„Éâ„Çπ„Ç≠„É£„Éä„Éº"></div>
      <div class="status" id="status" aria-live="polite">„Ç´„É°„É©„ÇíÂàùÊúüÂåñ‰∏≠...</div>
      <div class="result" id="result" aria-live="polite">„Çπ„Ç≠„É£„É≥ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
    </div>
    
    <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="controls">
      <button id="start-btn" class="btn btn-success" aria-label="„Çπ„Ç≠„É£„É≥ÈñãÂßã">‚ñ∂Ô∏è ÈñãÂßã</button>
      <button id="stop-btn" class="btn btn-danger" aria-label="„Çπ„Ç≠„É£„É≥ÂÅúÊ≠¢">‚èπÔ∏è ÂÅúÊ≠¢</button>
      <button id="switch-camera-btn" class="btn" aria-label="„Ç´„É°„É©ÂàáÊõø">üîÑ „Ç´„É°„É©ÂàáÊõø</button>
      <button id="save-btn" class="btn" aria-label="„Éá„Éº„Çø‰øùÂ≠ò">üíæ ‰øùÂ≠ò</button>
      <button id="export-btn" class="btn" aria-label="CSVÂá∫Âäõ">üì• CSVÂá∫Âäõ</button>
      <button id="clear-btn" class="btn btn-warning" aria-label="Â±•Ê≠¥ÂâäÈô§">üóëÔ∏è Â±•Ê≠¥ÂâäÈô§</button>
    </div>

    <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="section">
      <h3>üíæ „Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
      <div class="backup-section">
        <h4>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉ</h4>
        <button id="backup-btn" class="btn">üì¶ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê</button>
        <button id="restore-btn" class="btn">üìÇ Âæ©ÂÖÉ</button>
        <input type="file" id="restore-file" accept=".json" style="display:none;" aria-label="Âæ©ÂÖÉ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû">
        <div class="alert alert-warning" style="margin-top: var(--spacing-md);">
          ÂÆöÊúüÁöÑ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÊé®Â•®„Åó„Åæ„Åô
        </div>
      </div>
    </div>
    
    <!-- Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ -->
    <div class="section">
      <h3>üìä „Çπ„Ç≠„É£„É≥Â±•Ê≠¥ (<span id="history-count">0</span>‰ª∂)</h3>
      <div class="table-container">
        <table role="table" aria-label="„Çπ„Ç≠„É£„É≥Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´">
          <thead>
            <tr>
              <th scope="col">ÂìÅÁï™/„Éá„Éº„Çø</th>
              <th scope="col">ÂÖ•„ÇäÊï∞</th>
              <th scope="col">ÁÆ±Êï∞</th>
              <th scope="col">ÊôÇÂàª</th>
              <th scope="col">Êìç‰Ωú</th>
            </tr>
          </thead>
          <tbody id="history-body" role="rowgroup">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div id="edit-modal" class="modal" role="dialog" aria-labelledby="edit-modal-title" aria-hidden="true">
    <div class="modal-content">
      <span class="close" aria-label="Èñâ„Åò„Çã">&times;</span>
      <h3 id="edit-modal-title">„Éá„Éº„ÇøÁ∑®ÈõÜ</h3>
      <form id="edit-form">
        <div class="form-group">
          <label for="edit-data">„Çπ„Ç≠„É£„É≥„Éá„Éº„Çø:</label>
          <textarea id="edit-data" required aria-label="Á∑®ÈõÜ„Åô„Çã„Éá„Éº„Çø"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-irisu">ÂÖ•„ÇäÊï∞:</label>
          <input type="number" id="edit-irisu" min="1" step="1" required aria-label="ÂÖ•„ÇäÊï∞">
        </div>
        <div class="form-group">
          <label for="edit-hakosu">ÁÆ±Êï∞:</label>
          <input type="number" id="edit-hakosu" min="1" step="1" required aria-label="ÁÆ±Êï∞">
        </div>
        <div class="controls">
          <button type="submit" class="btn btn-success">üíæ ‰øùÂ≠ò</button>
          <button type="button" class="btn" id="cancel-edit">‚ùå „Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ÂÆöÊï∞ÂÆöÁæ©
    const CONFIG = {
      STORAGE_KEY: 'qrScanHistory_v2',
      SETTINGS_KEY: 'qrScanSettings_v2',
      DUPLICATE_TIME_LIMIT: 30000, // 30Áßí
      MAX_HISTORY_ITEMS: 1000,
      QUALITY_SETTINGS: {
        low: { fps: 15, aspectRatio: 1.0 },
        medium: { fps: 10, aspectRatio: 1.33 },
        high: { fps: 5, aspectRatio: 1.77 }
      },
      DEFAULT_PRODUCT_PATTERN: /\d{5}-\d{5}-\d{5}/,
      ERROR_MESSAGES: {
        CAMERA_PERMISSION: '„Ç´„É°„É©„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        CAMERA_NOT_FOUND: '„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éá„Éê„Ç§„Çπ„Å´„Ç´„É°„É©„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        CAMERA_IN_USE: '„Ç´„É°„É©„Åå‰ªñ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß‰ΩøÁî®‰∏≠„Åß„Åô„ÄÇ',
        SCAN_ERROR: '„Çπ„Ç≠„É£„É≥„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        UNKNOWN_ERROR: '‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ'
      }
    };

    // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇØ„É©„Çπ
    class QRReaderApp {
      constructor() {
        this.scanHistory = [];
        this.settings = {};
        this.qrReader = null;
        this.isScanning = false;
        this.currentFacingMode = "environment";
        this.lastScanTime = {};
        this.editingIndex = -1;
        
        console.log('QR„É™„Éº„ÉÄ„Éº„Ç¢„Éó„É™ÂàùÊúüÂåñÈñãÂßã');
        
        this.initializeElements();
        this.loadData();
        this.attachEventListeners();
        this.updateUI();
        
        // „Ç´„É°„É©Ê®©Èôê„ÅÆ‰∫ãÂâç„ÉÅ„Çß„ÉÉ„ÇØ
        this.checkCameraPermission();
        
        console.log('QR„É™„Éº„ÉÄ„Éº„Ç¢„Éó„É™ÂàùÊúüÂåñÂÆå‰∫Ü');
      }

      async checkCameraPermission() {
        try {
          // Ê®©ÈôêÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          if (navigator.permissions) {
            const permission = await navigator.permissions.query({ name: 'camera' });
            console.log('„Ç´„É°„É©Ê®©ÈôêÁä∂ÊÖã:', permission.state);
            
            if (permission.state === 'denied') {
              this.updateStatus('‚ùå „Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'danger');
            } else if (permission.state === 'prompt') {
              this.updateStatus('üì± „ÄåÈñãÂßã„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } else if (permission.state === 'granted') {
              this.updateStatus('üì± „Ç´„É°„É©„Ç¢„ÇØ„Çª„ÇπÊ∫ñÂÇôÂÆå‰∫Ü„ÄÇ„ÄåÈñãÂßã„Äç„Éú„Çø„É≥„Åß„Çπ„Ç≠„É£„É≥ÈñãÂßã');
            }
          } else {
            this.updateStatus('üì± „ÄåÈñãÂßã„Äç„Éú„Çø„É≥„Åß„Çπ„Ç≠„É£„É≥„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          }
        } catch (error) {
          console.log('Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ„Çπ„Ç≠„ÉÉ„Éó:', error);
          this.updateStatus('üì± QR„É™„Éº„ÉÄ„Éº„ÅÆÊ∫ñÂÇôÂÆå‰∫Ü');
        }
      }

      initializeElements() {
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó„Å®„Ç≠„É£„ÉÉ„Ç∑„É•
        this.elements = {
          reader: document.getElementById('reader'),
          status: document.getElementById('status'),
          result: document.getElementById('result'),
          historyBody: document.getElementById('history-body'),
          historyCount: document.getElementById('history-count'),
          
          // „Éú„Çø„É≥
          startBtn: document.getElementById('start-btn'),
          stopBtn: document.getElementById('stop-btn'),
          switchCameraBtn: document.getElementById('switch-camera-btn'),
          saveBtn: document.getElementById('save-btn'),
          exportBtn: document.getElementById('export-btn'),
          clearBtn: document.getElementById('clear-btn'),
          backupBtn: document.getElementById('backup-btn'),
          restoreBtn: document.getElementById('restore-btn'),
          restoreFile: document.getElementById('restore-file'),
          
          // Ë®≠ÂÆö
          extractionMode: document.getElementById('extraction-mode'),
          customPattern: document.getElementById('custom-pattern'),
          customPatternGroup: document.getElementById('custom-pattern-group'),
          qualitySelect: document.getElementById('quality-select'),
          qrboxSelect: document.getElementById('qrbox-select'),
          duplicateCheck: document.getElementById('duplicate-check'),
          
          // „É¢„Éº„ÉÄ„É´
          editModal: document.getElementById('edit-modal'),
          editForm: document.getElementById('edit-form'),
          editData: document.getElementById('edit-data'),
          editIrisu: document.getElementById('edit-irisu'),
          editHakosu: document.getElementById('edit-hakosu'),
          cancelEdit: document.getElementById('cancel-edit'),
          closeModal: document.querySelector('.close')
        };
      }

      loadData() {
        try {
          // Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
          const savedHistory = localStorage.getItem(CONFIG.STORAGE_KEY);
          this.scanHistory = savedHistory ? JSON.parse(savedHistory) : [];
          
          // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
          const savedSettings = localStorage.getItem(CONFIG.SETTINGS_KEY);
          this.settings = savedSettings ? JSON.parse(savedSettings) : {};
          
          // Ë®≠ÂÆö„ÇíUI„Å´ÂèçÊò†
          this.applySettings();
          
        } catch (error) {
          console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
          this.showAlert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
      }

      applySettings() {
        if (this.settings.extractionMode) {
          this.elements.extractionMode.value = this.settings.extractionMode;
        }
        if (this.settings.customPattern) {
          this.elements.customPattern.value = this.settings.customPattern;
        }
        if (this.settings.quality) {
          this.elements.qualitySelect.value = this.settings.quality;
        }
        if (this.settings.qrboxSize) {
          this.elements.qrboxSelect.value = this.settings.qrboxSize;
        }
        if (this.settings.duplicateCheck) {
          this.elements.duplicateCheck.value = this.settings.duplicateCheck;
        }
        
        this.toggleCustomPattern();
      }

      saveData() {
        try {
          // Â±•Ê≠¥„ÇíÂà∂ÈôêÊï∞„Åß„Éà„É™„É†
          if (this.scanHistory.length > CONFIG.MAX_HISTORY_ITEMS) {
            this.scanHistory = this.scanHistory.slice(-CONFIG.MAX_HISTORY_ITEMS);
          }
          
          localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(this.scanHistory));
          
          // Ë®≠ÂÆö‰øùÂ≠ò
          this.settings = {
            extractionMode: this.elements.extractionMode.value,
            customPattern: this.elements.customPattern.value,
            quality: this.elements.qualitySelect.value,
            qrboxSize: this.elements.qrboxSelect.value,
            duplicateCheck: this.elements.duplicateCheck.value
          };
          localStorage.setItem(CONFIG.SETTINGS_KEY, JSON.stringify(this.settings));
          
        } catch (error) {
          console.error('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
          this.showAlert('„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
      }

      attachEventListeners() {
        // „Ç´„É°„É©„Ç≥„É≥„Éà„É≠„Éº„É´
        this.elements.startBtn.addEventListener('click', () => this.toggleScanner());
        this.elements.stopBtn.addEventListener('click', () => this.stopScanner());
        this.elements.switchCameraBtn.addEventListener('click', () => this.switchCamera());
        
        // „Éá„Éº„ÇøÊìç‰Ωú
        this.elements.saveBtn.addEventListener('click', () => this.saveData());
        this.elements.exportBtn.addEventListener('click', () => this.exportCSV());
        this.elements.clearBtn.addEventListener('click', () => this.clearHistory());
        this.elements.backupBtn.addEventListener('click', () => this.createBackup());
        this.elements.restoreBtn.addEventListener('click', () => this.elements.restoreFile.click());
        this.elements.restoreFile.addEventListener('change', (e) => this.restoreBackup(e));
        
        // Ë®≠ÂÆöÂ§âÊõ¥
        this.elements.extractionMode.addEventListener('change', () => {
          this.toggleCustomPattern();
          this.restartScannerIfRunning();
        });
        this.elements.qualitySelect.addEventListener('change', () => this.restartScannerIfRunning());
        this.elements.qrboxSelect.addEventListener('change', () => this.restartScannerIfRunning());
        
        // „É¢„Éº„ÉÄ„É´
        this.elements.closeModal.addEventListener('click', () => this.closeEditModal());
        this.elements.cancelEdit.addEventListener('click', () => this.closeEditModal());
        this.elements.editForm.addEventListener('submit', (e) => this.saveEdit(e));
        
        // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => this.cleanup());
        window.addEventListener('visibilitychange', () => {
          if (document.hidden && this.isScanning) {
            console.log('„Éö„Éº„Ç∏„ÅåÈùûË°®Á§∫„Å´„Å™„Å£„Åü„Åü„ÇÅ„Çπ„Ç≠„É£„É≥„ÇíÂÅúÊ≠¢');
            this.stopScanner();
          }
        });
        
        // „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøúÔºà„Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜÔºâ
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (this.isScanning) {
              console.log('ÁîªÈù¢„Çµ„Ç§„Ç∫Â§âÊõ¥„Å´„Çà„Çä„Çπ„Ç≠„É£„Éä„Éº„ÇíÂÜçËµ∑Âãï');
              this.restartScannerIfRunning();
            }
          }, 1000); // 1Áßí„ÅÆ„Éá„Éê„Ç¶„É≥„Çπ
        });
        
        // ÁîªÈù¢ÂõûËª¢ÂØæÂøú
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (this.isScanning) {
              console.log('ÁîªÈù¢ÂõûËª¢„Å´„Çà„Çä„Çπ„Ç≠„É£„Éä„Éº„ÇíÂÜçËµ∑Âãï');
              this.restartScannerIfRunning();
            }
          }, 1000); // ÂõûËª¢ÂÆå‰∫Ü„ÇíÂæÖ„Å§
        });
      }

      toggleCustomPattern() {
        const isCustom = this.elements.extractionMode.value === 'custom';
        this.elements.customPatternGroup.style.display = isCustom ? 'flex' : 'none';
      }

      updateUI() {
        this.renderHistory();
        this.elements.historyCount.textContent = this.scanHistory.length;
        
        // „Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
        this.elements.startBtn.textContent = this.isScanning ? '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢' : '‚ñ∂Ô∏è ÈñãÂßã';
        this.elements.stopBtn.disabled = !this.isScanning;
        this.elements.exportBtn.disabled = this.scanHistory.length === 0;
        this.elements.clearBtn.disabled = this.scanHistory.length === 0;
      }

      renderHistory() {
        this.elements.historyBody.innerHTML = '';
        
        if (this.scanHistory.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="5" style="text-align:center;color:#ccc;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>';
          this.elements.historyBody.appendChild(emptyRow);
          return;
        }
        
        this.scanHistory.forEach((item, index) => {
          const row = this.createHistoryRow(item, index);
          this.elements.historyBody.appendChild(row);
        });
      }

      createHistoryRow(item, index) {
        const row = document.createElement('tr');
        row.setAttribute('role', 'row');
        
        const time = new Date(item.timestamp || Date.now()).toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const displayData = this.escapeHtml(item.data);
        const truncatedData = displayData.length > 15 ? displayData.substring(0, 15) + '...' : displayData;
        const statusIcon = 'üìÑ'; // ÂìÅÁï™ÊäΩÂá∫Ê©üËÉΩÁÑ°Âäπ„Å™„ÅÆ„ÅßÁµ±‰∏Ä„Ç¢„Ç§„Ç≥„É≥
        
        row.innerHTML = `
          <td class="data-cell" title="${displayData}">${statusIcon} ${truncatedData}</td>
          <td>${this.escapeHtml(item.irisu)}</td>
          <td>${this.escapeHtml(item.hakosu)}</td>
          <td>${time}</td>
          <td>
            <button class="btn btn-table" onclick="app.editItem(${index})" aria-label="Á∑®ÈõÜ">‚úèÔ∏è</button>
            <button class="btn btn-table" onclick="app.viewDetails(${index})" aria-label="Ë©≥Á¥∞">üëÅÔ∏è</button>
            <button class="btn btn-table btn-danger" onclick="app.deleteItem(${index})" aria-label="ÂâäÈô§">üóëÔ∏è</button>
          </td>
        `;
        
        return row;
      }

      // XSSÂØæÁ≠ñ„ÅÆHTML„Ç®„Çπ„Ç±„Éº„Éó
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      updateStatus(message, type = 'info') {
        this.elements.status.textContent = message;
        this.elements.status.className = `status ${type}`;
      }

      updateResult(message, isHtml = false) {
        if (isHtml) {
          this.elements.result.innerHTML = message;
        } else {
          this.elements.result.textContent = message;
        }
      }

      showAlert(message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        
        this.elements.result.innerHTML = '';
        this.elements.result.appendChild(alert);
        
        setTimeout(() => {
          if (this.elements.result.contains(alert)) {
            alert.remove();
          }
        }, 5000);
      }

      getQRBoxSize() {
        const selected = this.elements.qrboxSelect.value;
        if (selected === 'auto') {
          const width = Math.min(window.innerWidth - 40, 400);
          return Math.min(width * 0.7, 300);
        }
        return parseInt(selected);
      }

      getExtractionPattern() {
        const mode = this.elements.extractionMode.value;
        
        switch (mode) {
          case 'auto':
            return CONFIG.DEFAULT_PRODUCT_PATTERN;
          case 'custom':
            try {
              const pattern = this.elements.customPattern.value.trim();
              return pattern ? new RegExp(pattern) : null;
            } catch (error) {
              console.warn('„Ç´„Çπ„Çø„É†„Éë„Çø„Éº„É≥„ÅåÁÑ°Âäπ:', error);
              return null;
            }
          case 'manual':
            return CONFIG.DEFAULT_PRODUCT_PATTERN;
          default:
            return null;
        }
      }

      extractProductCode(qrCodeMessage) {
        const mode = this.elements.extractionMode.value;
        
        if (mode === 'off') {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const pattern = this.getExtractionPattern();
        if (!pattern) {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const match = qrCodeMessage.match(pattern);
        if (!match) {
          return { code: qrCodeMessage, isExtracted: false };
        }
        
        const extractedCode = match[0];
        
        if (mode === 'manual') {
          const confirmed = confirm(`ÂìÅÁï™„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü:\n${extractedCode}\n\nÂÖÉ„Éá„Éº„Çø: ${qrCodeMessage}\n\n„Åì„ÅÆÂìÅÁï™„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü`);
          if (!confirmed) {
            return { code: qrCodeMessage, isExtracted: false };
          }
        }
        
        return { code: extractedCode, isExtracted: true, originalData: qrCodeMessage };
      }

      checkDuplicate(data) {
        const duplicateMode = this.elements.duplicateCheck.value;
        
        if (duplicateMode === 'off') {
          return { isDuplicate: false };
        }
        
        const now = Date.now();
        
        if (duplicateMode === 'exact') {
          const exists = this.scanHistory.some(item => item.data === data);
          return { isDuplicate: exists, type: 'exact' };
        }
        
        if (duplicateMode === 'time') {
          const recent = this.lastScanTime[data];
          if (recent && (now - recent) < CONFIG.DUPLICATE_TIME_LIMIT) {
            return { isDuplicate: true, type: 'time', timeLeft: Math.ceil((CONFIG.DUPLICATE_TIME_LIMIT - (now - recent)) / 1000) };
          }
          this.lastScanTime[data] = now;
        }
        
        return { isDuplicate: false };
      }

      validateInput(irisu, hakosu) {
        const irisuNum = parseFloat(irisu);
        const hakosuNum = parseFloat(hakosu);
        
        if (isNaN(irisuNum) || irisuNum <= 0) {
          return { valid: false, message: 'ÂÖ•„ÇäÊï∞„ÅØÊ≠£„ÅÆÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
        }
        
        if (isNaN(hakosuNum) || hakosuNum <= 0) {
          return { valid: false, message: 'ÁÆ±Êï∞„ÅØÊ≠£„ÅÆÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
        }
        
        if (!Number.isInteger(irisuNum) || !Number.isInteger(hakosuNum)) {
          return { valid: false, message: 'ÂÖ•„ÇäÊï∞„Å®ÁÆ±Êï∞„ÅØÊï¥Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
        }
        
        return { valid: true };
      }

      async startScanner() {
        if (this.isScanning) {
          this.stopScanner();
          return;
        }
        
        try {
          this.updateStatus('„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...');
          
          // Êó¢Â≠ò„ÅÆQR„É™„Éº„ÉÄ„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
          if (this.qrReader) {
            try {
              await this.qrReader.stop();
              this.qrReader.clear();
            } catch (e) {
              console.warn('Êó¢Â≠òQR„É™„Éº„ÉÄ„Éº„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó:', e);
            }
          }
          
          this.qrReader = new Html5Qrcode("reader");
          
          const quality = CONFIG.QUALITY_SETTINGS[this.elements.qualitySelect.value];
          const qrboxSize = this.getQRBoxSize();
          
          const config = {
            fps: quality.fps,
            qrbox: qrboxSize,
            aspectRatio: quality.aspectRatio,
            disableFlip: false
          };

          // „Ç´„É°„É©Âà∂Á¥Ñ„Çí„Ç∑„É≥„Éó„É´„Å´
          const cameraConstraints = { facingMode: this.currentFacingMode };
          
          console.log('„Ç´„É°„É©Ëµ∑ÂãïÈñãÂßã:', { constraints: cameraConstraints, config });
          
          await this.qrReader.start(
            cameraConstraints,
            config,
            (qrCodeMessage) => this.handleScanSuccess(qrCodeMessage),
            (errorMessage) => {
              // ÈÄ£Á∂ö„Çπ„Ç≠„É£„É≥„Ç®„É©„Éº„ÅØÈÄöÂ∏∏ÁÑ°Ë¶ñ
              console.debug('„Çπ„Ç≠„É£„É≥„Ç®„É©„ÉºÔºàÊ≠£Â∏∏Ôºâ:', errorMessage);
            }
          );
          
          this.isScanning = true;
          this.updateStatus('üì∑ „Çπ„Ç≠„É£„É≥‰∏≠... QR„Ç≥„Éº„Éâ„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ', 'success');
          this.updateUI();
          
          console.log('„Ç´„É°„É©Ëµ∑ÂãïÊàêÂäü');
          
        } catch (error) {
          console.error('„Ç´„É°„É©Ëµ∑Âãï„Ç®„É©„Éº:', error);
          this.handleScanError(error);
        }
      }

      handleScanSuccess(qrCodeMessage) {
        try {
          // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥ÔºàÂØæÂøú„Éá„Éê„Ç§„Çπ„ÅÆ„ÅøÔºâ
          if (navigator.vibrate) {
            navigator.vibrate(100);
          }
          
          // ÂìÅÁï™ÊäΩÂá∫„ÅØÁÑ°Âäπ„Å™„ÅÆ„Åß„ÄÅ„Åù„ÅÆ„Åæ„Åæ„Éá„Éº„Çø„Çí‰ΩøÁî®
          const code = qrCodeMessage;
          const isExtracted = false;
          const originalData = qrCodeMessage;
          
          // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
          const duplicateCheck = this.checkDuplicate(code);
          
          let resultMessage = `‚úÖ Ë™≠„ÅøÂèñ„ÇäÊàêÂäü: ${this.escapeHtml(code)}`;
          
          if (duplicateCheck.isDuplicate) {
            resultMessage += `<br><div class="duplicate-warning">`;
            if (duplicateCheck.type === 'exact') {
              resultMessage += `‚ö†Ô∏è „Åì„ÅÆ„Éá„Éº„Çø„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
            } else if (duplicateCheck.type === 'time') {
              resultMessage += `‚ö†Ô∏è ${duplicateCheck.timeLeft}ÁßíÂâç„Å´„Çπ„Ç≠„É£„É≥„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`;
            }
            resultMessage += `</div>`;
          }
          
          this.updateResult(resultMessage, true);
          
          // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
          let confirmMessage = `Ë™≠„ÅøÂèñ„ÇäÁµêÊûú: ${code}\n\nÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü`;
          
          if (duplicateCheck.isDuplicate) {
            confirmMessage += '\n\n‚Äª ÈáçË§á„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô';
          }
          
          if (confirm(confirmMessage)) {
            this.showDataInputDialog(code, originalData, isExtracted);
          }
          
        } catch (error) {
          console.error('„Çπ„Ç≠„É£„É≥Âá¶ÁêÜ„Ç®„É©„Éº:', error);
          this.showAlert('„Çπ„Ç≠„É£„É≥„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
      }

      showDataInputDialog(code, originalData, isExtracted) {
        const irisu = prompt("ÂÖ•„ÇäÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "1");
        if (irisu === null) return;
        
        const hakosu = prompt("ÁÆ±Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "1");
        if (hakosu === null) return;
        
        const validation = this.validateInput(irisu, hakosu);
        if (!validation.valid) {
          alert(validation.message);
          return;
        }
        
        this.addHistoryItem(code, originalData, isExtracted, irisu, hakosu);
      }

      addHistoryItem(data, originalData, isExtracted, irisu, hakosu) {
        const newItem = {
          data: data,
          originalData: originalData,
          isExtracted: isExtracted,
          irisu: irisu,
          hakosu: hakosu,
          timestamp: Date.now()
        };
        
        this.scanHistory.push(newItem);
        this.saveData();
        this.updateUI();
        
        const status = isExtracted ? ' - ÂìÅÁï™ÊäΩÂá∫Ê∏à„Åø' : '';
        this.updateStatus(`‚úÖ „Éá„Éº„Çø„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü (${this.scanHistory.length}‰ª∂)${status}`, 'success');
      }

      handleScanError(error) {
        console.error('„Çπ„Ç≠„É£„É≥„Ç®„É©„ÉºË©≥Á¥∞:', error);
        
        let message = CONFIG.ERROR_MESSAGES.UNKNOWN_ERROR;
        let suggestion = '';
        
        // „Ç®„É©„Éº„ÅÆÁ®ÆÈ°û„ÇíË©≥Á¥∞„Å´Âà§ÂÆö
        const errorStr = error.toString().toLowerCase();
        
        if (error.name === 'NotAllowedError' || errorStr.includes('permission') || errorStr.includes('denied')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_PERMISSION;
          suggestion = 'Ëß£Ê±∫ÊñπÊ≥ï:\n1. „Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂ∑¶ÂÅ¥„ÅÆ„Ç´„É°„É©„Ç¢„Ç§„Ç≥„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ\n2. „ÄåË®±ÂèØ„Äç„ÇíÈÅ∏Êäû\n3. „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø';
        } else if (error.name === 'NotFoundError' || errorStr.includes('no camera') || errorStr.includes('not found')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_NOT_FOUND;
          suggestion = 'Ëß£Ê±∫ÊñπÊ≥ï:\n1. „Ç´„É°„É©„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç\n2. ‰ªñ„ÅÆ„Ç¢„Éó„É™„Åß„Ç´„É°„É©„Åå‰ΩøÁî®‰∏≠„Åß„Å™„ÅÑ„ÅãÁ¢∫Ë™ç\n3. „Éñ„É©„Ç¶„Ç∂„ÇíÂÜçËµ∑Âãï';
        } else if (error.name === 'NotReadableError' || errorStr.includes('in use') || errorStr.includes('busy')) {
          message = CONFIG.ERROR_MESSAGES.CAMERA_IN_USE;
          suggestion = 'Ëß£Ê±∫ÊñπÊ≥ï:\n1. ‰ªñ„ÅÆ„Çø„Éñ„ÇÑ„Ç¢„Éó„É™„Åß„Ç´„É°„É©„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç\n2. „Éñ„É©„Ç¶„Ç∂„ÇíÂÜçËµ∑Âãï\n3. „Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å';
        } else if (errorStr.includes('https') || errorStr.includes('secure')) {
          message = '„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„Å´„ÅØHTTPSÊé•Á∂ö„ÅåÂøÖË¶Å„Åß„Åô';
          suggestion = 'Ëß£Ê±∫ÊñπÊ≥ï:\n1. https://„ÅßÂßã„Åæ„ÇãURL„Åß„Ç¢„ÇØ„Çª„Çπ\n2. „É≠„Éº„Ç´„É´Áí∞Â¢É„ÅÆÂ†¥Âêà„ÅØlocalhost„Çí‰ΩøÁî®';
        }
        
        this.updateStatus(`‚ùå ${message}`, 'danger');
        this.showAlert(message, 'danger');
        
        if (suggestion) {
          console.log(suggestion);
          // Ë©≥Á¥∞„Å™„Ç®„É©„ÉºÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
          setTimeout(() => {
            if (confirm(`${message}\n\nË©≥Á¥∞„Å™Ëß£Ê±∫ÊñπÊ≥ï„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÅãÔºü`)) {
              alert(suggestion);
            }
          }, 1000);
        }
        
        this.isScanning = false;
        this.qrReader = null;
        this.updateUI();
      }

      stopScanner() {
        if (!this.isScanning && !this.qrReader) return;
        
        console.log('„Çπ„Ç≠„É£„Éä„ÉºÂÅúÊ≠¢ÈñãÂßã');
        
        this.isScanning = false;
        
        if (this.qrReader) {
          this.qrReader.stop().then(() => {
            console.log('„Çπ„Ç≠„É£„Éä„ÉºÊ≠£Â∏∏ÂÅúÊ≠¢');
            this.qrReader.clear();
            this.qrReader = null;
            this.updateStatus('‚èπÔ∏è „Çπ„Ç≠„É£„É≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
            this.updateResult('„Çπ„Ç≠„É£„É≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
            this.updateUI();
          }).catch(error => {
            console.warn('„Çπ„Ç≠„É£„Éä„ÉºÂÅúÊ≠¢„Ç®„É©„Éº:', error);
            this.qrReader.clear();
            this.qrReader = null;
            this.updateStatus('‚èπÔ∏è „Çπ„Ç≠„É£„É≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„ÅüÔºàÂº∑Âà∂Ôºâ');
            this.updateUI();
          });
        } else {
          this.updateStatus('‚èπÔ∏è „Çπ„Ç≠„É£„É≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
          this.updateUI();
        }
      }

      cleanup() {
        this.isScanning = false;
        if (this.qrReader) {
          try {
            this.qrReader.clear();
          } catch (error) {
            console.warn('QR„É™„Éº„ÉÄ„Éº„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
          }
          this.qrReader = null;
        }
        this.updateUI();
      }

      toggleScanner() {
        if (this.isScanning) {
          this.stopScanner();
        } else {
          this.startScanner();
        }
      }

      switchCamera() {
        if (this.isScanning) {
          this.stopScanner();
          setTimeout(() => {
            this.currentFacingMode = this.currentFacingMode === "environment" ? "user" : "environment";
            this.updateStatus(`üì∑ ${this.currentFacingMode === "environment" ? "ËÉåÈù¢" : "ÂâçÈù¢"}„Ç´„É°„É©„Å´ÂàáÊõø‰∏≠...`);
            this.startScanner();
          }, 500);
        } else {
          this.currentFacingMode = this.currentFacingMode === "environment" ? "user" : "environment";
          this.updateStatus(`üì∑ ${this.currentFacingMode === "environment" ? "ËÉåÈù¢" : "ÂâçÈù¢"}„Ç´„É°„É©„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`);
        }
      }

      restartScannerIfRunning() {
        if (this.isScanning && this.qrReader) {
          console.log('„Çπ„Ç≠„É£„Éä„ÉºÂÜçËµ∑ÂãïÈñãÂßã');
          this.stopScanner();
          // ÂçÅÂàÜ„Å™ÈñìÈöî„ÇíÁ©∫„Åë„Å¶ÂÜçËµ∑Âãï
          setTimeout(() => {
            console.log('„Çπ„Ç≠„É£„Éä„ÉºÂÜçËµ∑ÂãïÂÆüË°å');
            this.startScanner();
          }, 1000);
        }
      }

      exportCSV() {
        if (this.scanHistory.length === 0) {
          this.showAlert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
          return;
        }
        
        try {
          const now = new Date();
          const filename = `qr_history_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.csv`;
          
          const csvRows = ["„Çπ„Ç≠„É£„É≥„Éá„Éº„Çø,ÂÖ•„ÇäÊï∞,ÁÆ±Êï∞,ÁôªÈå≤ÊôÇÂàª"];
          
          this.scanHistory.forEach(item => {
            const time = new Date(item.timestamp || Date.now()).toLocaleString('ja-JP');
            const data = item.data.replace(/"/g, '""');
            
            csvRows.push(`"${data}","${item.irisu}","${item.hakosu}","${time}"`);
          });
          
          const csvContent = "\uFEFF" + csvRows.join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          
          const link = document.createElement("a");
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showAlert(`üì• ${filename} „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
          }
        } catch (error) {
          console.error('CSVÂá∫Âäõ„Ç®„É©„Éº:', error);
          this.showAlert('CSVÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
      }

      clearHistory() {
        if (this.scanHistory.length === 0) {
          this.showAlert('ÂâäÈô§„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
          return;
        }
        
        if (confirm(`Â±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n${this.scanHistory.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`)) {
          this.scanHistory = [];
          this.lastScanTime = {};
          this.saveData();
          this.updateUI();
          this.showAlert('üóëÔ∏è Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
        }
      }

      createBackup() {
        try {
          const backupData = {
            version: '2.0',
            timestamp: Date.now(),
            history: this.scanHistory,
            settings: this.settings
          };
          
          const now = new Date();
          const filename = `qr_backup_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.json`;
          
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const link = document.createElement("a");
          
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showAlert(`üì¶ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${filename}`, 'success');
          }
        } catch (error) {
          console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê„Ç®„É©„Éº:', error);
          this.showAlert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
        }
      }

      restoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (!backupData.version || !backupData.history) {
              throw new Error('ÁÑ°Âäπ„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Åß„Åô');
            }
            
            if (confirm(`„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Éá„Éº„Çø: ${this.scanHistory.length}‰ª∂\n„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø: ${backupData.history.length}‰ª∂\n\n‚ÄªÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô`)) {
              this.scanHistory = backupData.history || [];
              this.settings = backupData.settings || {};
              
              this.saveData();
              this.applySettings();
              this.updateUI();
              
              this.showAlert(`üìÇ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü (${this.scanHistory.length}‰ª∂)`, 'success');
            }
          } catch (error) {
            console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂæ©ÂÖÉ„Ç®„É©„Éº:', error);
            this.showAlert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'danger');
          }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
      }

      editItem(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        this.editingIndex = index;
        const item = this.scanHistory[index];
        
        this.elements.editData.value = item.data;
        this.elements.editIrisu.value = item.irisu;
        this.elements.editHakosu.value = item.hakosu;
        
        this.elements.editModal.style.display = 'block';
        this.elements.editModal.setAttribute('aria-hidden', 'false');
        this.elements.editData.focus();
      }

      saveEdit(event) {
        event.preventDefault();
        
        if (this.editingIndex < 0 || this.editingIndex >= this.scanHistory.length) {
          this.closeEditModal();
          return;
        }
        
        const data = this.elements.editData.value.trim();
        const irisu = this.elements.editIrisu.value.trim();
        const hakosu = this.elements.editHakosu.value.trim();
        
        const validation = this.validateInput(irisu, hakosu);
        if (!validation.valid) {
          alert(validation.message);
          return;
        }
        
        if (!data) {
          alert('„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }
        
        this.scanHistory[this.editingIndex].data = data;
        this.scanHistory[this.editingIndex].irisu = irisu;
        this.scanHistory[this.editingIndex].hakosu = hakosu;
        this.scanHistory[this.editingIndex].editedAt = Date.now();
        
        this.saveData();
        this.updateUI();
        this.closeEditModal();
        
        this.showAlert('‚úÖ „Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
      }

      closeEditModal() {
        this.elements.editModal.style.display = 'none';
        this.elements.editModal.setAttribute('aria-hidden', 'true');
        this.editingIndex = -1;
      }

      deleteItem(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        const item = this.scanHistory[index];
        if (confirm(`„Åì„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n„Éá„Éº„Çø: ${item.data}\nÂÖ•„ÇäÊï∞: ${item.irisu}\nÁÆ±Êï∞: ${item.hakosu}`)) {
          this.scanHistory.splice(index, 1);
          this.saveData();
          this.updateUI();
          this.showAlert('üóëÔ∏è „Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
        }
      }

      viewDetails(index) {
        if (index < 0 || index >= this.scanHistory.length) return;
        
        const item = this.scanHistory[index];
        const registeredTime = new Date(item.timestamp).toLocaleString('ja-JP');
        const editedTime = item.editedAt ? new Date(item.editedAt).toLocaleString('ja-JP') : '„Å™„Åó';
        
        const message = [
          'Ë©≥Á¥∞ÊÉÖÂ†±:',
          '',
          `„Çπ„Ç≠„É£„É≥„Éá„Éº„Çø: ${item.data}`,
          `ÂÖ•„ÇäÊï∞: ${item.irisu}`,
          `ÁÆ±Êï∞: ${item.hakosu}`,
          `ÁôªÈå≤ÊôÇÂàª: ${registeredTime}`,
          `Á∑®ÈõÜÊôÇÂàª: ${editedTime}`
        ].join('\n');
        
        alert(message);
      }
    }

    // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
    let app;
    
    document.addEventListener('DOMContentLoaded', () => {
      try {
        app = new QRReaderApp();
        console.log('QR„É™„Éº„ÉÄ„Éº„Ç¢„Éó„É™„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
      } catch (error) {
        console.error('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        document.getElementById('status').textContent = '„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
      }
    });

    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    window.addEventListener('click', (event) => {
      if (event.target === document.getElementById('edit-modal')) {
        app?.closeEditModal();
      }
    });

    // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        app?.closeEditModal();
      }
    });
  </script>
</body>
</html>